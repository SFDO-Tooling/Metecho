version: '3'

services:
  # Runs the Python server process:
  # Runs the JS client build and serve process:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - postgres
      - redis
    links:
      - "postgres:db"
      - redis
    env_file: .env
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.local
      REDIS_URL: redis://redis:6379
    volumes:
      - .:/app
      - /app/node_modules
      - ~/.gitconfig:/root/.gitconfig
    ports:
      - "0.0.0.0:8080:8080"
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s

  # Runs the database process:
  postgres:
    image: postgres:10.6
    environment:
      - POSTGRES_USER=metashare
    volumes:
      - ./postgres:/var/lib/postgresql/data

  # Runs the queue process:
  redis:
    image: redis:5.0

  # Sets up git hooks for local development:
  githooks:
    build:
      context: .
      dockerfile: ./compose/githooks/Dockerfile
    volumes:
      - ./.git:/tmp/.git
      - ./hooks:/tmp/hooks
